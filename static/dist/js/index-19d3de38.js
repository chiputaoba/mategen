import{d as V,p as f,ab as x,C as R,$ as T,o as B,c as I,a as l,w as c,b as A,L as S,J as d,ac as E,ad as k,ae as q,af as P,U as N,V as F,X as M,W as L,_ as U,I as z,l as H,x as J,a7 as Q,ag as W,ah as X}from"./index-67479de6.js";import{S as j}from"./index-2809fbc3.js";import"./svg-icons-d473d0e7.js";const G={class:"db-detail"},K={class:"group-btn"},O=V({__name:"Detail",emits:["showSessions"],setup($,{expose:v,emit:_}){const m=f(),u=x({showDialog:!1,db_id:""}),t=f({hostname:"",port:"",username:"",password:"",database_name:""}),g=x({hostname:[{required:!0,message:"不能为空",trigger:"blur"}],port:[{required:!0,message:"不能为空",trigger:"blur"}],username:[{required:!0,message:"不能为空",trigger:"blur"}],password:[{required:!0,message:"不能为空",trigger:"blur"}],database_name:[{required:!0,message:"不能为空",trigger:"blur"}]}),b=async()=>{u.showDialog=!1},w=async i=>{var a,n;if(!i){d({type:"error",message:"参数异常",customClass:"custom-message"});return}try{(a=m.value)==null||a.resetFields(),u.db_id=i;const e=await E(u.db_id);e.status===200&&((n=e.data)==null?void 0:n.status)===200&&(t.value.hostname=e.data.data.db_info.hostname,t.value.port=e.data.data.db_info.port+"",t.value.username=e.data.data.db_info.username,t.value.password=e.data.data.db_info.password,t.value.database_name=e.data.data.db_info.database_name,u.showDialog=!0)}catch(e){console.log("getDbInfoAPI error",e)}},h=async i=>{i&&await i.validate(async(a,n)=>{var e;if(a){const s=d({type:"info",message:"数据库保存中...",customClass:"custom-loading-message"});try{const r=await k(u.db_id,t.value);r.status===200&&((e=r.data)==null?void 0:e.status)===200?(y("showSessions"),s.close(),d({type:"success",message:"数据库保存成功！",customClass:"custom-message"})):(s.close(),d({type:"error",message:"数据库保存失败，请重试！",customClass:"custom-message"}))}catch{s.close(),d({type:"error",message:"数据库连接失败，请重试！",customClass:"custom-message"})}}})},D=async i=>{q.confirm("确认后该数据库连接会被删除，且不可恢复","确认删除？",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info",customClass:"custom-message-box"}).then(async()=>{var a;try{const n=await P(i);n.status===200&&((a=n.data)==null?void 0:a.status)===200&&(d({type:"success",message:"数据库连接删除成功",customClass:"custom-message"}),y("showSessions"),u.showDialog=!1)}catch{d({type:"error",message:"数据库连接删除失败",customClass:"custom-message"})}}).catch(()=>{})};v({openDetail:w,closeDetail:b});const y=_;return(i,a)=>{const n=N,e=F,s=M,r=L;return R((B(),I("div",G,[l(r,{ref_key:"formRef",ref:m,rules:g,model:t.value,class:"demo-form-dialog",style:{width:"max-content"},size:"large","label-width":72},{default:c(()=>[l(e,{label:"Host",prop:"hostname"},{default:c(()=>[l(n,{class:"input-width",modelValue:t.value.hostname,"onUpdate:modelValue":a[0]||(a[0]=o=>t.value.hostname=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,{label:"Port",prop:"port"},{default:c(()=>[l(n,{class:"input-width",modelValue:t.value.port,"onUpdate:modelValue":a[1]||(a[1]=o=>t.value.port=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,{label:"User",prop:"username"},{default:c(()=>[l(n,{class:"input-width",modelValue:t.value.username,"onUpdate:modelValue":a[2]||(a[2]=o=>t.value.username=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,{label:"Pwd",prop:"password"},{default:c(()=>[l(n,{class:"input-width",type:"password",modelValue:t.value.password,"onUpdate:modelValue":a[3]||(a[3]=o=>t.value.password=o),placeholder:"","show-password":""},null,8,["modelValue"])]),_:1}),l(e,{label:"db_name",prop:"database_name"},{default:c(()=>[l(n,{class:"input-width",modelValue:t.value.database_name,"onUpdate:modelValue":a[4]||(a[4]=o=>t.value.database_name=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,null,{default:c(()=>[A("div",K,[l(s,{class:"primary-btn",type:"primary",onClick:a[5]||(a[5]=o=>h(m.value))},{default:c(()=>a[7]||(a[7]=[S("保存")])),_:1}),l(s,{class:"default-btn",plain:"",onClick:a[6]||(a[6]=o=>D(u.db_id))},{default:c(()=>a[8]||(a[8]=[S(" 删除")])),_:1})])]),_:1})]),_:1},8,["rules","model"])],512)),[[T,u.showDialog]])}}});const Y=U(O,[["__scopeId","data-v-7c1ebbab"]]),Z={class:"db"},ee={class:"db-right"},se=V({__name:"index",setup($){const{proxy:v}=J(),_=f(),m=f(),u=f([]);v.$mitt.on("showAllDB",()=>{z(async()=>{g()})});const t=f({hostname:"",port:"",username:"",password:"",database_name:""}),g=async()=>{var e;u.value=[];try{const s=await Q();s.status===200&&((e=s.data)==null?void 0:e.status)===200&&s.data.data&&s.data.data.length>0&&(u.value=s.data.data.map(r=>({id:r.id,name:r.database_name})))}catch(s){console.log("createDbConnectionAPI error",s)}},b=()=>{var e;g(),(e=m.value)==null||e.closeDetail()},w=()=>{var e;(e=_.value)==null||e.openDialog()},h=e=>{var s;(s=m.value)==null||s.openDetail(e.id)},D=async e=>{var r,o;const s=d({type:"info",message:"数据库重命名中...",customClass:"custom-loading-message"});try{let p=await E(e.id);if(p.status===200&&((r=p.data)==null?void 0:r.status)===200){t.value.hostname=p.data.data.db_info.hostname,t.value.port=p.data.data.db_info.port+"",t.value.username=p.data.data.db_info.username,t.value.password=p.data.data.db_info.password,t.value.database_name=e.name;let C=await k(e.id,t.value);C.status===200&&((o=C.data)==null?void 0:o.status)===200?(s.close(),d({type:"success",message:"数据库重命名成功！",customClass:"custom-message"}),b()):(s.close(),d({type:"error",message:"数据库重命名失败，请重试！",customClass:"custom-message"}))}}catch{s.close(),d({type:"error",message:"数据库重命名失败，请重试！",customClass:"custom-message"})}},y=e=>{var s;(s=_.value)==null||s.openDialog(e.id)},i=async e=>{a(e.id)},a=async e=>{q.confirm("确认后该数据库连接会被删除，且不可恢复","确认删除？",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info",customClass:"custom-message-box"}).then(async()=>{var s,r;try{const o=await P(e);o.status===200&&((s=o.data)==null?void 0:s.status)===200&&(d({type:"success",message:"数据库连接删除成功",customClass:"custom-message"}),g(),(r=m.value)==null||r.closeDetail())}catch{d({type:"error",message:"数据库连接删除失败",customClass:"custom-message"})}}).catch(()=>{})},n=W();return H(()=>{var e;if(n.query.type&&n.query.type==="add"){(e=_.value)==null||e.openDialog();const s=window.location.hash.replace(/\?.*$/,"");history.replaceState({},"",s)}g()}),(e,s)=>(B(),I("div",Z,[l(j,{title:"添加数据库","session-type":"DB",list:u.value,onAddSession:w,onQuerySession:h,onEditSession:y,onEditSessionName:D,onDeleteSession:i},null,8,["list"]),A("div",ee,[l(Y,{ref_key:"DetailRef",ref:m,onShowSessions:b},null,512)]),l(X,{ref_key:"AddDialogRef",ref:_,onShowSessions:b},null,512)]))}});const le=U(se,[["__scopeId","data-v-73e0ad99"]]);export{le as default};
